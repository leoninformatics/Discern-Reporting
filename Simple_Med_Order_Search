/*
##################
Title:            Simple_Med_Order_Search with MRN filter
Summary:          Medication order search â€“ update "O.HNA_ORDER_MNEMONIC" for specific drug
Date Created:     05/11/2025
Last Updated:     05/11/2025
##################
*/

SELECT
    NAME = (P.NAME_FULL_FORMATTED)
    , MRN = (PA.ALIAS)
    , DOB = (P.BIRTH_DT_TM) "DD/MM/YYYY"
    , ORDER_ID = O.ORDER_ID
    , ORDER_START = O.CURRENT_START_DT_TM "DD/MM/YYYY HH:MM"
    , ORDER_END = O.DISCONTINUE_EFFECTIVE_DT_TM "DD/MM/YYYY HH:MM"
    , ORDERED_AS = O.ORDERED_AS_MNEMONIC
    , GENERIC_NAME = O.HNA_ORDER_MNEMONIC
    , ORDER_MNEMONIC = OI.ORDER_MNEMONIC
    , ORDER_TYPE = UAR_GET_CODE_DISPLAY(O.MED_ORDER_TYPE_CD)
    , ORDER_STATUS = UAR_GET_CODE_DISPLAY(O.ORDER_STATUS_CD)
    , WARD = UAR_GET_CODE_DISPLAY(E.LOC_NURSE_UNIT_CD)
    , HOSPITAL = UAR_GET_CODE_DISPLAY(E.LOC_FACILITY_CD)

FROM
    ORDERS O
    , ORDER_INGREDIENT OI
    , PERSON P
    , PERSON_ALIAS PA
    , ENCOUNTER E

PLAN O WHERE
    O.CURRENT_START_DT_TM BETWEEN CNVTDATETIME("01-nov-2023 00:00:00") AND CNVTDATETIME("31-dec-2023 23:59:59") ; EDIT DATE & TIME
    AND O.ACTIVE_IND = 1
    ;AND O.HNA_ORDER_MNEMONIC = "Tinzap*" ; EDIT FOR SPECIFIC MEDICATION

JOIN OI WHERE O.ORDER_ID = OI.ORDER_ID
    AND OI.ACTION_SEQUENCE = O.LAST_INGRED_ACTION_SEQUENCE

JOIN P WHERE O.PERSON_ID = P.PERSON_ID
    AND P.BIRTH_DT_TM < CNVTLOOKBEHIND("5,Y")
    AND P.NAME_FULL_FORMATTED NOT IN ("Zzztest, *", "Test Patient, *")

JOIN PA WHERE PA.PERSON_ID = P.PERSON_ID
    AND PA.PERSON_ALIAS_TYPE_CD = 10.00
    AND PA.ALIAS_POOL_CD = 14504365
    AND PA.ALIAS = "H04220329" ; FILTER FOR SPECIFIC MRN

JOIN E WHERE E.ENCNTR_ID = O.ENCNTR_ID
    AND E.LOC_FACILITY_CD = 14504354 ;(CUMH 14437846, UHK 14504356, ROH 14504354, NMH 14504352)

ORDER BY
    NAME
    , ORDERED_AS
    , O.ORDER_ID

WITH MAXREC = 20000, TIME = 300
